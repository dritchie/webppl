<html>
	<head>
		<title>SOSMC L-System Test UI</title>
		<script src='http://code.jquery.com/jquery-1.11.3.min.js'> </script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5.1/dat.gui.min.js'></script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/three.js/r72/three.min.js'></script>
		<script src='../render.js'></script>
	</head>
	<body onkeydown='keyEvent(event)'>
		<script>
			var numParticles;
			var particleHistory;
			var viewport;

			var guistate;
			var gui;
			var guicomponents;
			var generationSlider;
			var particleSlider;
			var scoreDisplay;
			var activeDisplay;

			var targetImgFile = '../targets/curl_600.png';
			var smallTargetImgFile = '../targets/curl_50.png';
			var targetImg;
			var smallTargetImg;

			function renderParticle(canvas, particle, tgtimage) {
				var ctx = canvas.getContext('2d');
				// Draw gray-ed out target as background
				ctx.drawImage(tgtimage, 0, 0);
				ctx.globalCompositeOperation = 'lighten';
				ctx.rect(0, 0, canvas.width, canvas.height);
				ctx.fillStyle = 'rgb(128, 128, 128)';
				ctx.fill();
				ctx.globalCompositeOperation = 'source-over';
				// Draw branches
				render(canvas, viewport, particle.branches, 0, particle.branches.length, false);
			}

			function showCurrentParticle() {
				var particle = particleHistory[guistate.generationIndex][guistate.particleIndex];
				
				var canvas = $('#canvas')[0];
				var ctx = canvas.getContext('2d');
				var canvas_small = $('#canvas-small')[0];
				var ctx_small = canvas_small.getContext('2d');

				// Draw
				if (particle.imageData) {
					ctx.putImageData(particle.imageData, 0, 0);
					ctx_small.putImageData(particle.imageDataSmall, 0, 0);
				} else {
					renderParticle(canvas, particle, targetImg);
					renderParticle(canvas_small, particle, smallTargetImg);
					// Save image
					particle.imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
					particle.imageDataSmall = ctx_small.getImageData(0, 0, canvas_small.width, canvas_small.height);
				}

				// Update UI
				scoreDisplay.setValue(particle.score);
				activeDisplay.setValue(particle.active);
			}

			function findBestInGen(genIndex) {
				var bestscore = -Infinity;
				var besti = -1;
				var particles = particleHistory[genIndex];
				for (var i = 0; i < particles.length; i++) {
					var p = particles[i];
					if (p.score > bestscore) {
						bestscore = p.score;
						besti = i;
					}
				}
				return besti;
			}

			function showBestInGen() {
				var besti = findBestInGen(guistate.generationIndex);
				particleSlider.setValue(besti);
			}

			function findBestOverall() {
				var bestscore = -Infinity;
				var besti = -1;
				var bestj = -1;
				for (var i = 0; i < particleHistory.length; i++) {
					var j = findBestInGen(i);
					var p = particleHistory[i][j];
					if (p.score > bestscore) {
						bestscore = p.score;
						besti = i;
						bestj = j;
					}
				}
				return {generationIndex: i, particleIndex: j};
			}

			function showBestOverall() {
				var best = findBestOverall();
				generationSlider.setValue(best.generationIndex);
				particleSlider.setValue(best.particleIndex);
			}

			// Arrow keys also allow navigation
			var LEFT_ARROW = 37;
			var UP_ARROW = 38;
			var RIGHT_ARROW = 39;
			var DOWN_ARROW = 40;
			function keyEvent(event) {
				var key = event.keyCode || event.which;
				if (particleHistory) {
					if (key === LEFT_ARROW) {
						var pindex = Math.max(guistate.particleIndex - 1, 0);
						particleSlider.setValue(pindex);
					} else if (key === RIGHT_ARROW) {
						var pindex = Math.min(guistate.particleIndex + 1, numParticles - 1);
						particleSlider.setValue(pindex);
					} else if (key === DOWN_ARROW) {
						var gindex = Math.max(guistate.generationIndex - 1, 0);
						generationSlider.setValue(gindex);
					} else if (key === UP_ARROW) {
						var gindex = Math.min(guistate.generationIndex + 1, particleHistory.length - 1);
						generationSlider.setValue(gindex);
					}
				}
			}

			function computeScoreRange(history) {
				var minscore = Infinity;
				var maxscore = -Infinity;
				for (var i = 0; i < history.length; i++) {
					var ps = history[i];
					for (var j = 0; j < ps.length; j++) {
						var p = ps[j];
						minscore = Math.min(minscore, p.score);
						maxscore = Math.max(maxscore, p.score);
					}
				}
				return {min: minscore, max: maxscore};
			}

			function generate() {
				console.log('Generating...');
				$.getJSON('http://localhost:8000', function(data) {
					// Process data
					console.log('   Received data; processing...');
					particleHistory = data.history;
					numParticles = particleHistory[0].length;
					var scoreRange = computeScoreRange(particleHistory);
					viewport = data.viewport;

					// GUI init
					if (!gui) {
						gui = new dat.GUI();
					} else {
						for (var i = 0; i < guicomponents.length; i++)
							gui.remove(guicomponents[i]);
					}
					guistate = {
						generationIndex: particleHistory.length - 1,
						particleIndex: findBestInGen(particleHistory.length - 1),
						score: 0,
						active: false,
						showBestInGen: showBestInGen,
						showBestOverall: showBestOverall,
					}
					generationSlider = gui.add(guistate, 'generationIndex', 0, particleHistory.length-1).step(1).name('Generation');
					generationSlider.onChange(showCurrentParticle);
					particleSlider = gui.add(guistate, 'particleIndex', 0, particleHistory[0].length-1).step(1).name('Particle');
					particleSlider.onChange(showCurrentParticle);
					scoreDisplay = gui.add(guistate, 'score', scoreRange.min, scoreRange.max).name('Score');
					activeDisplay = gui.add(guistate, 'active').name('Active?');
					var bestInGenButton = gui.add(guistate, 'showBestInGen').name('Best in gen.');
					var bestOverallButton = gui.add(guistate, 'showBestOverall').name('Best overall');
					guicomponents = [generationSlider, particleSlider, scoreDisplay, activeDisplay, bestInGenButton, bestOverallButton];

					// Display
					showCurrentParticle();

					console.log('   DONE.');
				});
			}

			// Body elements
			targetImg = new Image();
			targetImg.addEventListener('load', function() {
				$('<canvas/>', {id: 'canvas'}).prop({width: targetImg.width, height: targetImg.height}).appendTo('body');
				smallTargetImg = new Image();
				smallTargetImg.addEventListener('load', function() {
					$('<canvas/>', {id: 'canvas-small'}).prop({width: smallTargetImg.width, height: smallTargetImg.height}).appendTo('body');
					$('<button>Generate</button>').css('font-size', '18pt').click(generate).appendTo('body');
				}, false);
				smallTargetImg.src = smallTargetImgFile;
			}, false);
			targetImg.src = targetImgFile;

		</script>
	</body>
</html>




